
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The Calm Baby Map</title>
<link rel="icon" href="./favicon.ico">
<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#4b0082">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#ffffff;color:#4b0082}
  .app{max-width:860px;margin:0 auto;padding:20px}
  .card{background:#f8f0ff;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(75,0,130,.25)}
  h1{margin:.2rem 0 0.4rem;color:#4b0082}
  h2{color:#6a0dad;margin:.2rem 0 1rem}
  .grid{display:grid;gap:10px}
  button{padding:12px;background:#ffffff;border:2px solid #a64ca6;border-radius:12px;color:#4b0082;font-weight:500;cursor:pointer;text-align:left}
  button:hover{background:#e6ccff}
  .note{background:#f0e6ff;border:1px solid #c299ff;padding:8px 10px;border-radius:10px;color:#4b0082;margin-top:10px}
  .pill{display:inline-block;background:#a64ca6;color:#ffffff;padding:6px 10px;border-radius:999px;font-weight:800;margin-bottom:8px}
  .back{margin-top:10px;display:inline-block;color:#6a0dad;font-weight:600;cursor:pointer}
  .subtitle{font-size:1rem;font-weight:700;color:#6a0dad;margin-bottom:1rem}
  .footer{margin-top:12px;color:#6a0dad;font-size:.9rem}
.home-btn{position:fixed;left:16px;bottom:16px;background:#a64ca6;color:#fff;border:none;
  padding:12px 14px;border-radius:999px;font-weight:800;box-shadow:0 6px 20px rgba(75,0,130,.25);
  cursor:pointer}
.home-btn:hover{opacity:.95}
.home-btn:active{transform:translateY(1px)}
.tool-card{background:#fff;border:2px solid #a64ca6;border-radius:12px;padding:12px;margin:8px 0;color:#4b0082}
.tool-title{font-weight:800;margin-bottom:6px}
.tool-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.tool-btn{padding:8px 12px;border:2px solid #a64ca6;background:#f8f0ff;border-radius:10px;color:#4b0082;font-weight:700;cursor:pointer}
.tool-btn:hover{background:#e6ccff}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f0e6ff;border:1px solid #c299ff;border-radius:6px;padding:2px 6px}
.svg-wrap{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
.svg-box{background:#fff;border:2px solid #a64ca6;border-radius:12px;padding:10px}
.timer{font-weight:800;min-width:84px;display:inline-block}
hr.purple{border:none;border-top:2px solid #d1b3ff;margin:12px 0}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>The Calm Baby Map</h1>
    <div class="subtitle">for my baby Lydia</div>
    <div id="content" role="main" aria-live="polite"></div>
    <div class="footer">Tip: add this page to your home screen to use it like an app. Works offline after the first load.</div>
  </div>
</div>
<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js')); }

const flow = {
  start: { text: "Choose a scenario", options: [
    {text: "Breastfeeding: latch/full feeds", next: "bf_start"},
    {text: "Crying + pushing away", next: "cry_start"},
    {text: "Cluster feeding (evening)", next: "cluster_start"}
  ]},
  bf_start: { text: "What's happening right now?", options: [
    {text: "Baby won‚Äôt latch", next: "bf_wont"},
    {text: "Latch hurts / shallow", next: "bf_shallow"},
    {text: "Baby too sleepy at breast", next: "bf_sleepy"},
    {text: "Feeding but not getting full", next: "bf_notfull"}
  ]},
  bf_wont: { text: "Try in order", list: [
    "Skin-to-skin in dim light for 2‚Äì3 min.",
    "Laid-back position; nose-to-nipple; wait for wide mouth.",
    "Soften a firm breast (hand-express 1‚Äì2 min).",
    "Drip a little milk on lip; bring baby on chin-first.",
    "Offer 1‚Äì5 mL expressed milk, then reattempt latch."
  ], options: [
    {text: "Baby latched ‚Üí keep milk flowing", next: "bf_active"},
    {text: "Still no latch ‚Üí protect supply & feed expressed milk", next: "bf_protect"}
  ], back: "bf_start" },
  bf_active: { text: "Keep milk flowing", list: [
    "Watch suck‚Äìswallow rhythm.",
    "Breast compressions when sucking slows.",
    "Burp and switch sides if sleepy."
  ], note: "If most feeds are still tough after 24‚Äì48h, book an IBCLC and check weight/diapers.", back: "bf_start" },
  bf_protect: { text: "Protect milk supply this feed", list: [
    "Pump 10‚Äì15 min (both sides).",
    "Feed expressed milk.",
    "Try latching next feed; repeat steps above."
  ], options: [{text: "Happening most feeds? ‚Üí Get hands-on help", next: "bf_help"}], back: "bf_start" },
  bf_help: { text: "Get hands-on help", list: [
    "Book an IBCLC.",
    "Check diapers (‚â•6 wets & ‚â•3‚Äì4 yellow stools/day after day 4).",
    "Follow plan while protecting supply."
  ], back: "bf_start" },
  bf_shallow: { text: "Deepen the latch", list: [
    "Nose-to-nipple; wait for wide mouth.",
    "Bring baby to you, chin first.",
    "Try football or side-lying hold.",
    "If pain >30 sec, break seal and relatch."
  ], back: "bf_start" },
  bf_sleepy: { text: "Wake and engage", list: [
    "Skin-to-skin; undress to diaper.",
    "Rub feet/back, quick diaper change.",
    "Breast compressions to keep swallowing."
  ], back: "bf_start" },
  bf_notfull: { text: "Boost transfer", list: [
    "Start on fuller side; compressions.",
    "Switch sides when swallowing slows; burp in between.",
    "Warm compress/massage before let-down."
  ], back: "bf_start" },
  cry_start: { text: "Pick what fits best", options: [
    {text: "Loud cry + pushing away", next: "cry_overstim"},
    {text: "Fussy during/after feed", next: "cry_feed"},
    {text: "Seems overtired", next: "cry_tired"},
    {text: "Possible discomfort", next: "cry_comfort"}
  ]},
  cry_overstim: { text: "Reset stimulation", list: [
    "Dim lights, lower noise.",
    "Hold upright facing away; sway.",
    "Once calmer, soothe normally."
  ], back: "cry_start" },
  cry_feed: { text: "Is it during or after feeding?", options: [
    {text: "During feed ‚Üí Adjust", next: "cry_during"},
    {text: "After feed ‚Üí Post-feed soothe", next: "cry_after"}
  ], back: "cry_start" },
  cry_during: { text: "Adjust the feed", list: [
    "Pause to burp; keep upright.",
    "Bottle: tweak nipple flow.",
    "Breast: try laid-back or side-lying; relatch."
  ], back: "cry_start" },
  cry_after: { text: "Post-feed soothe", list: [
    "Hold upright 10‚Äì20 min.",
    "Colic hold.",
    "Avoid active play right away."
  ], back: "cry_start" },
  cry_tired: { text: "Settle for sleep", list: [
    "Swaddle (if under ~8 weeks and not rolling).",
    "Dark room + white noise.",
    "Slow rocking/bouncing."
  ], back: "cry_start" },
  cry_comfort: { text: "Quick comfort checks", list: [
    "Diaper, clothing tags, hair tourniquet.",
    "Gas relief: burp, bicycle legs.",
    "If persistent, call provider."
  ], back: "cry_start" },
  cluster_start: { text: "How does this evening look?", options: [
    {text: "Multiple consecutive hours", next: "cluster_prolonged"},
    {text: "Frequent but calm between", next: "cluster_calm"},
    {text: "Frequent and crying", next: "cluster_fussy"},
    {text: "It‚Äôs past midnight", next: "cluster_latenight"}
  ]},
  cluster_prolonged: { text: "Set up for the long haul", list: [
    "Pick evening nest.",
    "Feed both sides; compressions.",
    "Between feeds: burp, change, hold.",
    "Rotate holds to protect your body."
  ], options: [
    {text: "Baby calm between", next: "cluster_calm"},
    {text: "Baby fussy between", next: "cluster_fussy"}
  ], back: "cluster_start" },
  cluster_calm: { text: "Content between feeds", list: [
    "Pace yourself: break every 30‚Äì45 min.",
    "Support holds; side-lying.",
    "If sore: drizzle milk to help latch."
  ], back: "cluster_start" },
  cluster_fussy: { text: "Fussy between feeds", list: [
    "Lower stimulation.",
    "Burp more than usual; colic hold.",
    "Swaddle reset."
  ], back: "cluster_start" },
  burp_positions: { text: "Burping Positions (with visuals)",
  html: `
  <div class="svg-wrap">
    <div class="svg-box">
      <div class="tool-title">Over-Shoulder</div>
      <svg width="180" height="140" viewBox="0 0 180 140" xmlns="http://www.w3.org/2000/svg" aria-label="Over shoulder burping illustration">
        <rect x="0" y="0" width="180" height="140" rx="12" fill="#f8f0ff" stroke="#a64ca6"/>
        <circle cx="60" cy="70" r="28" fill="#ffe0bd" stroke="#6a0dad"/>
        <rect x="90" y="40" width="18" height="60" rx="8" fill="#a64ca6" opacity="0.3"/>
        <circle cx="120" cy="50" r="18" fill="#ffe0bd" stroke="#6a0dad"/>
        <path d="M70,55 Q80,45 92,50" stroke="#6a0dad" fill="none"/>
        <circle cx="52" cy="65" r="3" fill="#4b0082"/>
        <circle cx="68" cy="65" r="3" fill="#4b0082"/>
        <path d="M52,78 Q60,88 68,78" stroke="#c23" stroke-width="3" fill="none"/>
        <path d="M115,85 q10 -8 20 0" stroke="#6a0dad" stroke-width="3" fill="none" marker-end="url(#arrow)"/>
        <defs>
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
            <path d="M0,0 L0,6 L6,3 z" fill="#6a0dad"/>
          </marker>
        </defs>
      </svg>
      <div class="muted">Hold baby high on your shoulder; gentle pats on upper back.</div>
    </div>
    <div class="svg-box">
      <div class="tool-title">Sitting Lap</div>
      <svg width="180" height="140" viewBox="0 0 180 140" xmlns="http://www.w3.org/2000/svg" aria-label="Sitting lap burping illustration">
        <rect x="0" y="0" width="180" height="140" rx="12" fill="#f8f0ff" stroke="#a64ca6"/>
        <rect x="55" y="90" width="70" height="14" rx="7" fill="#a64ca6" opacity="0.3"/>
        <circle cx="90" cy="65" r="18" fill="#ffe0bd" stroke="#6a0dad"/>
        <rect x="78" y="82" width="24" height="10" rx="5" fill="#ffe0bd" stroke="#6a0dad"/>
        <line x1="115" y1="60" x2="140" y2="50" stroke="#6a0dad" stroke-width="3" marker-end="url(#arrow2)"/>
        <defs>
          <marker id="arrow2" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
            <path d="M0,0 L0,6 L6,3 z" fill="#6a0dad"/>
          </marker>
        </defs>
      </svg>
      <div class="muted">Sit baby upright on your lap; support chin & chest; pat or rub back.</div>
    </div>
    <div class="svg-box">
      <div class="tool-title">Tummy-Down Over Lap</div>
      <svg width="180" height="140" viewBox="0 0 180 140" xmlns="http://www.w3.org/2000/svg" aria-label="Tummy down burping illustration">
        <rect x="0" y="0" width="180" height="140" rx="12" fill="#f8f0ff" stroke="#a64ca6"/>
        <rect x="40" y="85" width="100" height="16" rx="8" fill="#a64ca6" opacity="0.3"/>
        <ellipse cx="100" cy="70" rx="28" ry="16" fill="#ffe0bd" stroke="#6a0dad"/>
        <circle cx="120" cy="63" r="7" fill="#ffe0bd" stroke="#6a0dad"/>
        <path d="M52,60 q-8 12 0 24" stroke="#6a0dad" stroke-width="3" fill="none" marker-end="url(#arrow3)"/>
        <defs>
          <marker id="arrow3" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
            <path d="M0,0 L0,6 L6,3 z" fill="#6a0dad"/>
          </marker>
        </defs>
      </svg>
      <div class="muted">Lay baby tummy-down across your lap; support head slightly higher than chest; pat gently.</div>
    </div>
  </div>
  <div class="note">Try each position for ~2‚Äì3 minutes. If no burp, switch positions and continue calmly.</div>
  `,
  back: "start"
},

tools: { text: "Tools: Timers & Calming Audio",
  html: `
  <div class="tool-card">
    <div class="tool-title">Timers</div>
    <div class="tool-row"><span class="timer" id="t_latch">03:00</span>
      <button class="tool-btn" onclick="startTimer('latch',180)">Start 3‚Äëmin Latch</button>
      <button class="tool-btn" onclick="stopTimer('latch')">Stop</button>
      <button class="tool-btn" onclick="resetTimer('latch',180)">Reset</button>
    </div>
    <div class="tool-row"><span class="timer" id="t_pump">15:00</span>
      <button class="tool-btn" onclick="startTimer('pump',900)">Start 15‚Äëmin Pump</button>
      <button class="tool-btn" onclick="stopTimer('pump')">Stop</button>
      <button class="tool-btn" onclick="resetTimer('pump',900)">Reset</button>
    </div>
    <div class="tool-row"><span class="timer" id="t_switch">00:00</span>
      <button class="tool-btn" onclick="startSideSwitch()">Start Side‚ÄëSwitch</button>
      <button class="tool-btn" onclick="stopSideSwitch()">Stop</button>
      <span class="muted">Beeps every 5 min; shows elapsed.</span>
    </div>
  </div>
  <hr class="purple"/>
  <div class="tool-card">
    <div class="tool-title">Calming Audio (loops until you stop)</div>
    <div class="tool-row">
      <button class="tool-btn" onclick="playTrack('lullaby')">Play Lullaby</button>
      <button class="tool-btn" onclick="playTrack('whitenoise')">Play White Noise</button>
      <button class="tool-btn" onclick="playTrack('heartbeat')">Play Heartbeat</button>
      <button class="tool-btn" onclick="stopAudio()">Stop</button>
    </div>
    <div class="muted">Starts only when you tap Play. All audio is generated on‚Äëdevice (no copyrights).</div>
  </div>
  `,
  back: "start"
},

cluster_latenight: { text: "When cluster rolls past midnight", list: [
    "Switch to night mode.",
    "Contact sleep or bassinet with warm-up.",
    "Protect one longer stretch."
  ], back: "cluster_start" }
};

let stack = ["start"];

function babyBurst(){
  const baby = document.createElement('div');
  baby.textContent = 'üë∂üòä';
  baby.style.position = 'fixed';
  baby.style.fontSize = '4rem';
  baby.style.zIndex = 9999;
  baby.style.left = (window.innerWidth/2 - 32) + 'px';
  baby.style.top = (window.innerHeight/2 - 32) + 'px';
  baby.style.transition = 'opacity .9s ease';
  document.body.appendChild(baby);
  setTimeout(()=>{ baby.style.opacity = '0'; }, 50);
  setTimeout(()=>baby.remove(), 950);
}

function render(key){
  const node = flow[key];
  let html = `<h2>${node.text}</h2>`;
  if(node.list){ html += '<ul>' + node.list.map(x=>`<li>${x}</li>`).join('') + '</ul>'; }
  if(node.options){
    html += '<div class="grid">' + node.options.map(o=>`<button onclick="go('${o.next}')">${o.text}</button>`).join('') + '</div>';
  }
  if(node.note){ html += `<div class="note">${node.note}</div>`; }
  if(node.back){ html += `<div class="back" onclick="back()">‚Üê Back</div>`; }
  document.getElementById('content').innerHTML = html;
}

function go(next){
  stack.push(next);
  babyBurst();
  render(next);
}

function back(){
  stack.pop();
  render(stack[stack.length-1]);
}

/* Tools JS */
const timers = {};
function formatTime(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
function tickTimer(key){
  const t = timers[key]; if(!t) return;
  const now = Date.now();
  const left = Math.max(0, t.end - now);
  const sec = Math.ceil(left/1000);
  document.getElementById('t_'+key).textContent = formatTime(sec);
  if(left <= 0){ stopTimer(key); try{ navigator.vibrate && navigator.vibrate([200,100,200]); }catch(e){} }
  else { t.raf = requestAnimationFrame(()=> tickTimer(key)); }
}
function startTimer(key, seconds){
  stopTimer(key);
  const el = document.getElementById('t_'+key);
  timers[key] = { end: Date.now() + seconds*1000, raf: null, base: seconds };
  tickTimer(key);
}
function stopTimer(key){ const t = timers[key]; if(!t) return; cancelAnimationFrame(t.raf); delete timers[key]; }
function resetTimer(key, seconds){ stopTimer(key); const el = document.getElementById('t_'+key); if(el) el.textContent = formatTime(seconds); }

let sideSwitchInterval=null, sideStart=null;
function startSideSwitch(){
  stopSideSwitch();
  sideStart = Date.now();
  document.getElementById('t_switch').textContent = '00:00';
  sideSwitchInterval = setInterval(()=>{
    const elapsed = Math.floor((Date.now()-sideStart)/1000);
    document.getElementById('t_switch').textContent = formatTime(elapsed);
    if(elapsed % 300 === 0){ try{ navigator.vibrate && navigator.vibrate([150,80,150]); }catch(e){} }
  }, 1000);
}
function stopSideSwitch(){ if(sideSwitchInterval){ clearInterval(sideSwitchInterval); sideSwitchInterval=null; } }

/* Audio (copyright-free, generated on-device) */
let AC = null, current = null, noiseNode = null, beatInterval = null, lullabyNotes = null, lullabyStep = 0, lullabyInterval = null;
function ensureAC(){ if(!AC) AC = new (window.AudioContext || window.webkitAudioContext)(); return AC; }
function stopAudio(){
  if(!AC) return;
  if(current){ current.stop(0); current.disconnect(); current=null; }
  if(noiseNode){ noiseNode.disconnect(); noiseNode=null; }
  if(beatInterval){ clearInterval(beatInterval); beatInterval=null; }
  if(lullabyInterval){ clearInterval(lullabyInterval); lullabyInterval=null; }
}
function playTrack(kind){
  stopAudio();
  const ac = ensureAC();
  if(kind==='whitenoise'){
    const bufferSize = 2 * ac.sampleRate;
    const buffer = ac.createBuffer(1, bufferSize, ac.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0; i<bufferSize; i++){ data[i] = Math.random()*2-1; }
    const src = ac.createBufferSource(); src.buffer = buffer; src.loop = true;
    const gain = ac.createGain(); gain.gain.value = 0.1;
    src.connect(gain).connect(ac.destination); src.start(0);
    current = src; noiseNode = src;
  } else if(kind==='heartbeat'){
    const kick = ()=>{
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = 'sine'; o.frequency.setValueAtTime(150, ac.currentTime);
      o.frequency.exponentialRampToValueAtTime(50, ac.currentTime+0.1);
      g.gain.setValueAtTime(0.0001, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.6, ac.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.25);
      o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+0.3);
    };
    // double-beat every ~0.8s
    beatInterval = setInterval(()=>{ kick(); setTimeout(kick, 200); }, 800);
  } else if(kind==='lullaby'){
    // simple arpeggio loop (C major): C E G A G E (in Hz), gentle envelope
    lullabyNotes = [261.63, 329.63, 392.00, 440.00, 392.00, 329.63];
    lullabyStep = 0;
    lullabyInterval = setInterval(()=>{
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = 'sine'; o.frequency.value = lullabyNotes[lullabyStep % lullabyNotes.length];
      g.gain.setValueAtTime(0.0001, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.35);
      o.connect(g).connect(ac.destination);
      o.start(); o.stop(ac.currentTime+0.4);
      lullabyStep++;
    }, 500);
  }
}

render("start");
</script>
<button class="home-btn" aria-label="Go to Home" onclick="goHome()">üè† Home</button>
<script>
function goHome(){
  stack = ["start"];
  /* Tools JS */
const timers = {};
function formatTime(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
function tickTimer(key){
  const t = timers[key]; if(!t) return;
  const now = Date.now();
  const left = Math.max(0, t.end - now);
  const sec = Math.ceil(left/1000);
  document.getElementById('t_'+key).textContent = formatTime(sec);
  if(left <= 0){ stopTimer(key); try{ navigator.vibrate && navigator.vibrate([200,100,200]); }catch(e){} }
  else { t.raf = requestAnimationFrame(()=> tickTimer(key)); }
}
function startTimer(key, seconds){
  stopTimer(key);
  const el = document.getElementById('t_'+key);
  timers[key] = { end: Date.now() + seconds*1000, raf: null, base: seconds };
  tickTimer(key);
}
function stopTimer(key){ const t = timers[key]; if(!t) return; cancelAnimationFrame(t.raf); delete timers[key]; }
function resetTimer(key, seconds){ stopTimer(key); const el = document.getElementById('t_'+key); if(el) el.textContent = formatTime(seconds); }

let sideSwitchInterval=null, sideStart=null;
function startSideSwitch(){
  stopSideSwitch();
  sideStart = Date.now();
  document.getElementById('t_switch').textContent = '00:00';
  sideSwitchInterval = setInterval(()=>{
    const elapsed = Math.floor((Date.now()-sideStart)/1000);
    document.getElementById('t_switch').textContent = formatTime(elapsed);
    if(elapsed % 300 === 0){ try{ navigator.vibrate && navigator.vibrate([150,80,150]); }catch(e){} }
  }, 1000);
}
function stopSideSwitch(){ if(sideSwitchInterval){ clearInterval(sideSwitchInterval); sideSwitchInterval=null; } }

/* Audio (copyright-free, generated on-device) */
let AC = null, current = null, noiseNode = null, beatInterval = null, lullabyNotes = null, lullabyStep = 0, lullabyInterval = null;
function ensureAC(){ if(!AC) AC = new (window.AudioContext || window.webkitAudioContext)(); return AC; }
function stopAudio(){
  if(!AC) return;
  if(current){ current.stop(0); current.disconnect(); current=null; }
  if(noiseNode){ noiseNode.disconnect(); noiseNode=null; }
  if(beatInterval){ clearInterval(beatInterval); beatInterval=null; }
  if(lullabyInterval){ clearInterval(lullabyInterval); lullabyInterval=null; }
}
function playTrack(kind){
  stopAudio();
  const ac = ensureAC();
  if(kind==='whitenoise'){
    const bufferSize = 2 * ac.sampleRate;
    const buffer = ac.createBuffer(1, bufferSize, ac.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0; i<bufferSize; i++){ data[i] = Math.random()*2-1; }
    const src = ac.createBufferSource(); src.buffer = buffer; src.loop = true;
    const gain = ac.createGain(); gain.gain.value = 0.1;
    src.connect(gain).connect(ac.destination); src.start(0);
    current = src; noiseNode = src;
  } else if(kind==='heartbeat'){
    const kick = ()=>{
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = 'sine'; o.frequency.setValueAtTime(150, ac.currentTime);
      o.frequency.exponentialRampToValueAtTime(50, ac.currentTime+0.1);
      g.gain.setValueAtTime(0.0001, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.6, ac.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.25);
      o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+0.3);
    };
    // double-beat every ~0.8s
    beatInterval = setInterval(()=>{ kick(); setTimeout(kick, 200); }, 800);
  } else if(kind==='lullaby'){
    // simple arpeggio loop (C major): C E G A G E (in Hz), gentle envelope
    lullabyNotes = [261.63, 329.63, 392.00, 440.00, 392.00, 329.63];
    lullabyStep = 0;
    lullabyInterval = setInterval(()=>{
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = 'sine'; o.frequency.value = lullabyNotes[lullabyStep % lullabyNotes.length];
      g.gain.setValueAtTime(0.0001, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.35);
      o.connect(g).connect(ac.destination);
      o.start(); o.stop(ac.currentTime+0.4);
      lullabyStep++;
    }, 500);
  }
}

render("start");
}
</script>
</body>
</html>
